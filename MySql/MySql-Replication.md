##### 一、概述		

​		master->slave(也可以当另一slave的master、即slave->slave)。

​		MySQL支持两种复制方式：基于行的复制和基于语句的复制。这两种方式都是通过在主库记录二进制日志、在备库重放日志的方式来实现异步的数据复制。这意味着，在同一时间点备库上的数据可能与主库存在不一致，并且无法保证主备之间的延迟。一些大的语句可能导致备库产生几秒、几分钟甚至几个小时的延迟。

​		复制通常不会增加主库的开销，主要是启用二进制日志带来的开销，但出于备份或及时从崩溃中恢复的目的，这点开销也是必要的。除此之外，每个备库也会对主库增加一些负载（例如网络I/O开销），尤其当备库请求从主库读取旧的二进制日志文件时，可能会造成更高的I/O开销。

##### 二、复制如何工作

​		总的来说，复制有三个步骤

1、在主库上把数据更改记录到二进制日志（Binary Log）中（这些记录被称为二进制日志事件）。

2、备库将主库上的日志复制到自己的中继日志（Relay Log）中。

3、备库读取中继日志中的事件，将其重放到备库数据之上。

##### 三、配置复制

​		为MySQL服务器配置复制非常简单。但由于场景不同，基本的步骤还是有所差异。总的来说，配置复制分为以下几步：

1、在每台服务器上创建复制账号。

2、配置主库和备库。

3、通知备库连接到主库并从主库复制数据。

​		接下来我们将展示如何一步步配置复制：假设有服务器server1（IP地址192.168.0.1）和服务器server2（IP地址192.168.0.2）

1、创建复制账号

​		MySQL会赋予一些特殊的权限给复制线程。在备库运行的I/O线程会建立一个到主库的TCP/IP连接，这意味着必须在主库创建一个用户，并赋予其合适的权限。备库I/O线程以该用户名连接到主库并读取其二进制日志。通过如下语句创建用户账号：

~~~mysql
mysql> GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.*
~~~

2、配置主库和备库

​		下一步需要在主库上开启一些设置，假设主库是服务器server1，需要打开二进制日志并指定一个独一无二的服务器ID（server ID），在主库的my.cnf文件中增加或修改如下内容：

~~~mysql
log_bin=mysql-bin
server_id=10
~~~

​		 实际取值由你决定，必须明确地指定一个唯一的服务器ID，默认服务器ID通常为1（这和版本相关，一些MySQL版本根本不允许使用这个值），使用默认值可能会导致和其它服务器的ID冲突。一种通用的做法是使用服务器IP地址的末8位，但要保证它是不变且唯一的。

​		如果之前没有在MySQL的配置文件中指定log_bin选项，就需要重新启动MySQL。为了确认二进制日志文件是否已经在主库上创建，使用show master status

​		备库上也需要在my.cnf中增加类似的配置，并且同样需要重启服务器。

~~~mysql
log_bin=mysql-bin
server_id=2
relay_log=/var/lib/mysql/mysql-relay-bin（指定中继日志的位置和命名）
log_slave_updates=1（允许备库将其重放的事件也记录到自身的二进制日志中）
read_only=1
~~~

3、启动复制

​		这步是告诉备库如何连接到主库并重放其二进制日志。这一步不要通过修改my.cnf来配置，而是使用CHANGE MASTER TO语句，该语句完全替代了my.cnf中相应的设置，并且运行以后指向别的主库时无需重启备库。下面是开始复制的基本命令：

~~~mysql
mysql>change master to master_host='server1',
         ->master_user='repl',
         ->master_password='p4ssword',
         ->master_log_file='mysql-bin.000001',
         ->master_log_pos=0;
     运行以下语句来检查复制是否正确执行：
     mysql>show slave status
     运行下面的命令开始复制：
     mysql>start slave;
~~~

4、从另一个服务器开始复制

​		大多数情况下有一个已经运行了一段时间的主库，然后用一台新安装的备库与之同步，此时这台备库还没有数据。有几种办法来初始化备库或者从其它服务器克隆数据到备库。包括从主库复制数据、从另一台备库克隆数据，以及使用最近的一次备份来启动备库，需要有三个条件来让主库和备库保持同步：

1）在某个时间点的主库的数据快照。
2）主库当前的二进制日志文件，和获得数据快照时在该二进制日志文件中的偏移量，我们把这两个值称为日志文件坐标。通过这两个值可以确定二进制日志的位置。可以通过show master status命令来获取这些值。
3）从快照时间到现在的二进制日志。

5、推荐的复制配置

​		有许多参数来控制复制，其中一些会对数据安全和性能产生影响。这里推荐一种“安全”的配置，可以最小化问题发生的概率。在主库上二进制日志最重要的选项是sync_binlog：sync_binlog=1如果开启该选项，MySQL每次在提交事务前会将二进制日志同步到磁盘上，保证服务器崩溃时不会丢失事件。如果禁止该选项，服务器会少做一些工作，但二进制日志文件可能在服务器崩溃时损坏或丢失信息。